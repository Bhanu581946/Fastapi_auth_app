<!DOCTYPE html>
<html>
<head> 
    <meta charset="UTF-8">
    <title>Task Create</title>
    <style>
        body{
            font-family: Arial, Helvetica, sans-serif;
            background:whitesmoke;
            text-align: center;
            padding:20px;
        
        }
        input[type="text"] {
             padding: 8px;
             width: 200px;
             border-radius: 4px;
             border: 1px solid #999;
             font-size: 16px;
             margin:15px;
             cursor: pointer;
    }

        button{
            width:250px;
            padding:10px;
            border: none;
            border-radius: 6px;
            background: lightblue;
            color: white;
            font-size: 18px;

        }
        button:hover{
            background: darkblue;

        }

    </style>
  
</head>
<body>
    <h2>Create Task</h2>
    
    <p><b>Board ID:</b> <span id="boardId"></span></p><br>
    <label>User ID:</label>
    <input type="number" id="userId" placeholder="Enter User ID"><br><br>
    
    <label>Title:</label> 
    <input type ="text" id ="title" placeholder="Task title"><br>
    <label>Description:</label> 
    <input type ="text" id ="description" placeholder="Task description"><br><br>

    <button id="createTask">Create Task</button>

    <script>
        const API = "http://127.0.0.1:8000";
        const token= localStorage.getItem("token")
        if(!token){
            alert("Please login first")
            window.location.href= "login.html"
        }
        function authHeaders(){
            return{
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            }
        }
        const params = new URLSearchParams(window.location.search)
        const board_id = params.get("board_id")

        if(!board_id){
            alert("board not found")
            window.location.href ="board_list.html"
        }
        
        // Show board_id 
        document.getElementById("boardId").innerHTML = board_id;

        // OWNER CHECK
        async function loadData() {

            //Load board members 
            const memberRes = await fetch(`${API}/boards/members/${board_id}`, {
                headers: authHeaders()
            });

            const members = await memberRes.json();

            // Decode current user ID from JWT
            const currentUserId = JSON.parse(atob(token.split(".")[1])).sub;
    
           // Find me
            const me = members.find(m => m.user_id == currentUserId);

            if (!me) {
                alert("You are not a member of this board!");
                window.location.href = "board_list.html";
                return;
            }

            // Restrict only owner
            if (me.role.toLowerCase() !== "owner") {
                alert("Only owner can create task!");
                window.location.href = "board_list.html";
                return;
            }
    
        }
        loadData();
      

        //  Create Task
        document.getElementById("createTask").addEventListener("click", async ()=>{


        const title =document.getElementById("title").value
        const description =document.getElementById("description").value
        const userId = document.getElementById("userId").value;
    
        if(!title||!description){
            alert("Please fill all fields");
            return;
        }
        const res= await fetch(`${API}/tasks/`,{
            method:"POST",
            headers:authHeaders(),
            body: JSON.stringify({
                title: title,
                description: description,
                board_id: parseInt (board_id),
                assignee_id: userId ? parseInt(userId) : null
            })
        });
        const data =await res.json();
        console.log(data);
    
        if(res.ok){
            alert("Task created Successfully");
            window.location.href = `tasks.html?board_id=${board_id}`;
        }else{
            alert("Error:" + data.detail);
        }

    });  

    </script>
</body>

</html>